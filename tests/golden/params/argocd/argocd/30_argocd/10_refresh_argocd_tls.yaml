apiVersion: v1
kind: ServiceAccount
metadata:
  annotations: {}
  labels:
    name: syn-argocd-tls-refresher
  name: syn-argocd-tls-refresher
  namespace: syn
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations: {}
  labels:
    name: syn-argocd-tls-refresher
  name: syn-argocd-tls-refresher
  namespace: syn
rules:
  - apiGroups:
      - ''
    resources:
      - secrets
    verbs:
      - get
      - list
      - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations: {}
  labels:
    name: syn-argocd-tls-refresher
  name: syn-argocd-tls-refresher
  namespace: syn
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: syn-argocd-tls-refresher
subjects:
  - kind: ServiceAccount
    name: syn-argocd-tls-refresher
    namespace: syn
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations: {}
  labels:
    name: syn-argocd-tls-refresher
  name: syn-argocd-tls-refresher
  namespace: syn
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      completions: 1
      parallelism: 1
      template:
        metadata:
          labels:
            name: syn-argocd-tls-refresher
        spec:
          containers:
            - args:
                - |
                  #!/bin/bash

                  # This script refreshes all ArgoCD TLS secrets by deleting them,
                  # allowing the ArgoCD operator to recreate them with updated certificates.
                  # It does so by identifying secrets controlled by argoproj.io/v1beta1.ArgoCD resources.

                  set -euo pipefail

                  for nsname in $(kubectl get secrets -A --field-selector=type=kubernetes.io/tls -ojson | jq -r '.items[] | select(.metadata.ownerReferences // [] | any(.apiVersion=="argoproj.io/v1beta1" and .kind=="ArgoCD" and .controller==true)) | .metadata.namespace+"/"+.metadata.name'); do
                    echo "Refreshing ArgoCD TLS secret: $nsname"
                    kubectl -n "${nsname%%/*}" delete secret "${nsname##*/}"
                  done

                  echo "All ArgoCD TLS secrets have been refreshed."
              command:
                - /bin/bash
                - -c
              env:
                - name: HOME
                  value: /home/refresh
              image: quay.io/appuio/oc:v4.20
              imagePullPolicy: IfNotPresent
              name: refresh
              ports: []
              stdin: false
              tty: false
              volumeMounts:
                - mountPath: /home/refresh
                  name: home
          imagePullSecrets: []
          initContainers: []
          restartPolicy: OnFailure
          serviceAccountName: syn-argocd-tls-refresher
          terminationGracePeriodSeconds: 30
          volumes:
            - emptyDir: {}
              name: home
  schedule: 0 9 1 */4 *
  successfulJobsHistoryLimit: 10
